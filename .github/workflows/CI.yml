name: iOS Build & Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: macos-26
    timeout-minutes: 45

    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      - name: Select Xcode 26
        run: |
          echo "‚úÖ Using Xcode 26"
          sudo xcode-select -switch /Applications/Xcode_26.0.1.app
      
      - name: Clear SwiftPM protoc artifact cache (workaround)
        run: |
          PROTOC_CACHE=~/Library/Caches/org.swift.swiftpm/artifacts/https___github_com_apple_swift_protobuf_releases_download_protoc_artifactbundle_v31_1_protoc_31_1_artifactbundle_zip
          if [ -e "$PROTOC_CACHE" ]; then
            echo "üßπ Removing stale SwiftPM protoc artifact bundle at $PROTOC_CACHE"
            rm -rf "$PROTOC_CACHE"
          fi

      - name: Create mock Firebase configuration files
        run: |
          # Create the GoogleServicePLists directory
          mkdir -p AIChat/GoogleServicePLists
          
          # Create mock GoogleService-Info-Dev.plist for CI builds
          cat > AIChat/GoogleServicePLists/GoogleService-Info-Dev.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CLIENT_ID</key>
            <string>mock-client-id</string>
            <key>REVERSED_CLIENT_ID</key>
            <string>mock-reversed-client-id</string>
            <key>API_KEY</key>
            <string>mock-api-key</string>
            <key>GCM_SENDER_ID</key>
            <string>123456789</string>
            <key>PLIST_VERSION</key>
            <string>1</string>
            <key>BUNDLE_ID</key>
            <string>com.aichat.dev</string>
            <key>PROJECT_ID</key>
            <string>mock-project-id</string>
            <key>STORAGE_BUCKET</key>
            <string>mock-project-id.appspot.com</string>
            <key>IS_ADS_ENABLED</key>
            <false/>
            <key>IS_ANALYTICS_ENABLED</key>
            <false/>
            <key>IS_APPINVITE_ENABLED</key>
            <true/>
            <key>IS_GCM_ENABLED</key>
            <true/>
            <key>IS_SIGNIN_ENABLED</key>
            <true/>
            <key>GOOGLE_APP_ID</key>
            <string>1:123456789:ios:abcdef123456</string>
            <key>DATABASE_URL</key>
            <string>https://mock-project-id.firebaseio.com</string>
          </dict>
          </plist>
          EOF
          
          # Create mock GoogleService-Info-Prod.plist for CI builds
          cat > AIChat/GoogleServicePLists/GoogleService-Info-Prod.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CLIENT_ID</key>
            <string>mock-client-id-prod</string>
            <key>REVERSED_CLIENT_ID</key>
            <string>mock-reversed-client-id-prod</string>
            <key>API_KEY</key>
            <string>mock-api-key-prod</string>
            <key>GCM_SENDER_ID</key>
            <string>987654321</string>
            <key>PLIST_VERSION</key>
            <string>1</string>
            <key>BUNDLE_ID</key>
            <string>com.aichat.prod</string>
            <key>PROJECT_ID</key>
            <string>mock-project-id-prod</string>
            <key>STORAGE_BUCKET</key>
            <string>mock-project-id-prod.appspot.com</string>
            <key>IS_ADS_ENABLED</key>
            <false/>
            <key>IS_ANALYTICS_ENABLED</key>
            <false/>
            <key>IS_APPINVITE_ENABLED</key>
            <true/>
            <key>IS_GCM_ENABLED</key>
            <true/>
            <key>IS_SIGNIN_ENABLED</key>
            <true/>
            <key>GOOGLE_APP_ID</key>
            <string>1:987654321:ios:fedcba654321</string>
            <key>DATABASE_URL</key>
            <string>https://mock-project-id-prod.firebaseio.com</string>
          </dict>
          </plist>
          EOF

      - name: Verify Environment Variables Are Set
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MIXPANEL_TOKEN: ${{ secrets.MIXPANEL_TOKEN }}
          NEWSAPI_API_KEY: ${{ secrets.NEWSAPI_API_KEY }}
        run: |
          echo "Verifying GitHub Secrets are properly injected as environment variables..."
          if [ -n "$OPENAI_API_KEY" ]; then
            echo "‚úÖ Keys: OpenAI API Key loaded from ENV: ${OPENAI_API_KEY:0:8}***"
          else
            echo "‚ùå Keys: OpenAI API Key NOT found in environment"
          fi

          if [ -n "$MIXPANEL_TOKEN" ]; then
            echo "‚úÖ Keys: Mixpanel Token loaded from ENV: ${MIXPANEL_TOKEN:0:8}***"
          else
            echo "‚ùå Keys: Mixpanel Token NOT found in environment"
          fi

          if [ -n "$NEWSAPI_API_KEY" ]; then
            echo "‚úÖ Keys: NewsAPI Key loaded from ENV: ${NEWSAPI_API_KEY:0:8}***"
          else
            echo "‚ùå Keys: NewsAPI Key NOT found in environment"
          fi

      - name: Show environment info
        run: |
          sw_vers
          xcodebuild -version
          xcrun simctl list devices

      - name: List available Xcode schemes (debugging)
        run: xcodebuild -list
        
      - name: Build Project
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MIXPANEL_TOKEN: ${{ secrets.MIXPANEL_TOKEN }}
          NEWSAPI_API_KEY: ${{ secrets.NEWSAPI_API_KEY }}
        run: |
            xcodebuild clean build \
            -project AIChat.xcodeproj \
            -scheme "AIChat - Development" \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=latest' \
            ONLY_ACTIVE_ARCH=YES

      - name: Run Unit Tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MIXPANEL_TOKEN: ${{ secrets.MIXPANEL_TOKEN }}
          NEWSAPI_API_KEY: ${{ secrets.NEWSAPI_API_KEY }}
        run: |
            xcodebuild test \
            -project AIChat.xcodeproj \
            -scheme "AIChat - Development" \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=latest' \
            -only-testing:AIChatTests \
            ONLY_ACTIVE_ARCH=YES

      - name: Clean DerivedData for UI Tests
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
            echo "üßπ Cleaning DerivedData before UI tests"
            rm -rf ~/Library/Developer/Xcode/DerivedData/AIChat-*

      - name: Boot & Configure Simulator for UI Tests
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
            echo "üöÄ Setting up simulator for UI tests"
            
            # Get the device UUID
            DEVICE_UUID=$(xcrun simctl list devices available | grep "iPhone 17 Pro" | grep -v "unavailable" | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')
            echo "Device UUID: $DEVICE_UUID"
            
            # Shutdown any running simulators
            xcrun simctl shutdown all 2>/dev/null || true
            
            # Erase the simulator to start fresh
            xcrun simctl erase "$DEVICE_UUID" || true
            
            # Boot the simulator
            echo "‚è≥ Booting simulator..."
            xcrun simctl boot "$DEVICE_UUID" || echo "Simulator may already be booted"

            # Wait for simulator to be fully booted using bootstatus (blocks until ready)
            echo "‚è≥ Waiting for simulator to be ready..."
            timeout 120 xcrun simctl bootstatus "$DEVICE_UUID" -b || echo "Simulator boot completed or timeout reached"

            # Additional wait to ensure services are ready
            sleep 3
            echo "‚úÖ Simulator is ready"
            
            # Disable animations and accessibility features that can interfere with UI tests
            echo "‚öôÔ∏è Configuring simulator for UI testing"

            # Disable keyboard helpers and autocorrection
            xcrun simctl ui "$DEVICE_UUID" increase_contrast disable || true
            xcrun simctl ui "$DEVICE_UUID" reduce_motion enable || true

            # Allow time for settings to apply
            sleep 2
            
            # Verify simulator status
            xcrun simctl list devices | grep "iPhone 17 Pro"
            
            # Give the simulator extra time to settle
            sleep 5

      - name: Build UI Test Target
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MIXPANEL_TOKEN: ${{ secrets.MIXPANEL_TOKEN }}
          NEWSAPI_API_KEY: ${{ secrets.NEWSAPI_API_KEY }}
        run: |
            echo "üî® Building UI test target with Mock scheme"
            xcodebuild build-for-testing \
            -project AIChat.xcodeproj \
            -scheme "AIChat - Mock" \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=latest' \
            -only-testing:AIChatUITests \
            ONLY_ACTIVE_ARCH=YES

      - name: Run UI Tests (Main Branch Only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MIXPANEL_TOKEN: ${{ secrets.MIXPANEL_TOKEN }}
          NEWSAPI_API_KEY: ${{ secrets.NEWSAPI_API_KEY }}
        run: |
            echo "üß™ Running UI Tests on main branch with Mock scheme"

            # Run tests without building (already built in previous step)
            xcodebuild test-without-building \
            -project AIChat.xcodeproj \
            -scheme "AIChat - Mock" \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=latest' \
            -only-testing:AIChatUITests \
            ONLY_ACTIVE_ARCH=YES \
            -maximum-concurrent-test-device-destinations 1 \
            -test-timeouts-enabled YES \
            -default-test-execution-time-allowance 120 \
            -maximum-test-execution-time-allowance 180 \
            -resultBundlePath ./UITestResults.xcresult \
            || {
                echo "‚ùå UI Tests failed on first attempt, retrying..."
                sleep 10

                # Retry once on failure
                xcodebuild test-without-building \
                -project AIChat.xcodeproj \
                -scheme "AIChat - Mock" \
                CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO \
                -sdk iphonesimulator \
                -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=latest' \
                -only-testing:AIChatUITests \
                ONLY_ACTIVE_ARCH=YES \
                -maximum-concurrent-test-device-destinations 1 \
                -test-timeouts-enabled YES \
                -default-test-execution-time-allowance 120 \
                -maximum-test-execution-time-allowance 180 \
                -resultBundlePath ./UITestResults-Retry.xcresult
            }
      
      - name: Upload UI Test Results
        if: always() && (github.event_name == 'push' && github.ref == 'refs/heads/main')
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-results
          path: |
            UITestResults.xcresult
            UITestResults-Retry.xcresult
          retention-days: 7

#      - name: Build app
#        run: |
#          echo "üöÄ Starting xcodebuild"
#          set -o pipefail && xcodebuild \
#            -scheme "AIChat - Development" \
#            -sdk iphonesimulator \
#            -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.1' \
#            build | tee xcodebuild.log | xcpretty
#
#      - name: Run Unit/UI Tests
#        run: |
#            echo "üß™ Running Unit/UI Tests"
#            set -o pipefail && xcodebuild \
#            -scheme "AIChat - Development" \
#            -sdk iphonesimulator \
#            -destination 'platform=iOS Simulator,name=iPhone 16 Pro,OS=18.2' \
#            test | tee xctest.log | xcpretty

      - name: Upload test results and logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-and-logs
          path: |
            xcodebuild.log
            xctest.log
            ~/Library/Developer/Xcode/DerivedData/AIChat-*/Logs/Test/
          retention-days: 7
